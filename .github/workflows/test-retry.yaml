name: Test Retry Mechanism

on:
  workflow_dispatch:

jobs:
  test-retry:
    runs-on: ubuntu-latest
    steps:
      - name: Failing step
        id: failing-step
        continue-on-error: true
        run: |
          echo "This is a test step that will fail"
          
          # 50/50 chance to output the flaky error or a different error
          if [ $((RANDOM % 2)) -eq 0 ]; then
            echo "üé≤ Randomly selected: FLAKY ERROR (will trigger retry)"
            ERROR_MSG="Error: buildx failed with: ERROR: failed to build: failed to solve: frontend grpc server closed unexpectedly"
            echo "$ERROR_MSG"
          else
            echo "üé≤ Randomly selected: DIFFERENT ERROR (will NOT trigger retry)"
            ERROR_MSG="Error: Some completely different error that doesn't match the flaky pattern"
            echo "$ERROR_MSG"
          fi
          
          # Write error to file for next step to read
          echo "$ERROR_MSG" > /tmp/step-error.txt
          
          exit 1

      - name: Check error and retry if needed
        if: steps.failing-step.outcome == 'failure'
        id: check-error
        shell: bash
        run: |
          echo "Step failed, checking error message..."
          
          # Read the error from the file written by the failing step
          if [ -f /tmp/step-error.txt ]; then
            ERROR_CONTENT=$(cat /tmp/step-error.txt)
            echo "Error message captured: $ERROR_CONTENT"
            
            # Check if the error matches the specific flaky error pattern
            if echo "$ERROR_CONTENT" | grep -q "Error: buildx failed with: ERROR: failed to build: failed to solve: frontend grpc server closed unexpectedly"; then
              echo "‚úÖ Detected flaky grpc server error, will retry"
              echo "should_retry=true" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Different error detected, will not retry"
              echo "should_retry=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è Could not find error file, will not retry"
            echo "should_retry=false" >> $GITHUB_OUTPUT
          fi
          
          # Clean up
          rm -f /tmp/step-error.txt

      - name: Sleep before retry
        if: steps.failing-step.outcome == 'failure' && steps.check-error.outputs.should_retry == 'true'
        run: |
          echo "Sleeping for 30s before retry..."
          sleep 30

      - name: Retry step
        if: steps.failing-step.outcome == 'failure' && steps.check-error.outputs.should_retry == 'true'
        id: retry-step
        run: |
          echo "This is the retry step"
          echo "Retry successful!"

      - name: Fail if step did not succeed
        if: steps.failing-step.outcome == 'failure' && (steps.check-error.outputs.should_retry != 'true' || steps['retry-step'].outcome != 'success')
        run: |
          echo "Step failed and retry was not attempted or retry also failed"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "TEST SUMMARY"
          echo "=========================================="
          echo "Failing step outcome: ${{ steps.failing-step.outcome }}"
          echo "Should retry: ${{ steps.check-error.outputs.should_retry }}"
          if [ "${{ steps.failing-step.outcome }}" == "failure" ]; then
            if [ "${{ steps.check-error.outputs.should_retry }}" == "true" ]; then
              if [ "${{ steps.retry-step.outcome }}" == "success" ]; then
                echo "‚úÖ RESULT: Flaky error detected ‚Üí Retry succeeded ‚Üí Job should pass"
              else
                echo "‚ùå RESULT: Flaky error detected ‚Üí Retry failed ‚Üí Job should fail"
              fi
            else
              echo "‚ùå RESULT: Different error (not flaky) ‚Üí No retry ‚Üí Job should fail"
            fi
          else
            echo "‚úÖ RESULT: First step succeeded ‚Üí No retry needed ‚Üí Job should pass"
          fi
          echo "=========================================="

