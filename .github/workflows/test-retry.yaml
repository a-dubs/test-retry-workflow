name: Test Retry Mechanism

on:
  workflow_dispatch:

jobs:
  test-retry:
    runs-on: ubuntu-latest
    steps:
      - name: Failing step
        id: failing-step
        continue-on-error: true
        run: |
          echo "This is a test step that will fail"
          
          # 50/50 chance to output the flaky error or a different error
          if [ $((RANDOM % 2)) -eq 0 ]; then
            echo "üé≤ Randomly selected: FLAKY ERROR (will trigger retry)"
            echo "Error: buildx failed with: ERROR: failed to build: failed to solve: frontend grpc server closed unexpectedly"
          else
            echo "üé≤ Randomly selected: DIFFERENT ERROR (will NOT trigger retry)"
            echo "Error: Some completely different error that doesn't match the flaky pattern"
          fi
          
          exit 1

      - name: Check error and retry if needed
        if: steps.failing-step.outcome == 'failure'
        id: check-error
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Step failed, fetching logs to check if retry is needed..."
          
          # Function to check if error pattern matches
          check_error_pattern() {
            local log_file="$1"
            if grep -q "Error: buildx failed with: ERROR: failed to build: failed to solve: frontend grpc server closed unexpectedly" "$log_file" 2>/dev/null || \
               grep -q "ERROR: failed to build: failed to solve: frontend grpc server closed unexpectedly" "$log_file" 2>/dev/null; then
              return 0
            fi
            return 1
          }
          
          # Try GitHub CLI first if available (more reliable)
          if command -v gh &> /dev/null; then
            echo "Using GitHub CLI to fetch logs..."
            
            # Wait a bit for logs to be available, then try to download
            for wait_time in 10 20 30; do
              echo "Waiting ${wait_time}s for logs to be available..."
              sleep $wait_time
              
              # GitHub CLI automatically uses GITHUB_TOKEN from environment
              if gh run view ${{ github.run_id }} --log > /tmp/workflow-logs.txt 2>&1; then
                # Check if we actually got logs (not an error message)
                if [ -s /tmp/workflow-logs.txt ] && ! grep -q "^Error:" /tmp/workflow-logs.txt; then
                  echo "Successfully fetched logs via GitHub CLI"
                  if check_error_pattern /tmp/workflow-logs.txt; then
                    echo "‚úÖ Detected flaky grpc server error, will retry"
                    echo "should_retry=true" >> $GITHUB_OUTPUT
                    rm -f /tmp/workflow-logs.txt
                    exit 0
                  else
                    echo "‚ùå Build failed with a different error, will not retry"
                    echo "should_retry=false" >> $GITHUB_OUTPUT
                    rm -f /tmp/workflow-logs.txt
                    exit 0
                  fi
                else
                  echo "GitHub CLI returned error or empty logs, will try API..."
                fi
              else
                echo "GitHub CLI fetch attempt failed, will try API..."
              fi
            done
            echo "GitHub CLI method failed after all attempts, trying API..."
          fi
          
          # Fallback to GitHub API with longer waits
          # Logs may not be immediately available, so we wait longer
          LOGS_URL="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/logs"
          
          # Wait longer and retry more times since logs may take time to be available
          for wait_time in 15 30 45; do
            echo "Waiting ${wait_time}s before attempting to download logs..."
            sleep $wait_time
            
            # Try downloading logs
            for i in 1 2 3; do
              if curl -f -L -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "$LOGS_URL" -o /tmp/workflow-logs.zip 2>/dev/null; then
                echo "Successfully downloaded logs"
                
                # Extract the zip file
                if unzip -q /tmp/workflow-logs.zip -d /tmp/workflow-logs/ 2>/dev/null; then
                  # Find the log file for the "Failing step"
                  STEP_LOG=""
                  for pattern in "*Failing step*" "*failing-step*" "*Failing*"; do
                    STEP_LOG=$(find /tmp/workflow-logs -type f -iname "$pattern" | head -1)
                    if [ -n "$STEP_LOG" ]; then
                      break
                    fi
                  done
                  
                  # If still not found, search all log files for the error pattern
                  if [ -z "$STEP_LOG" ]; then
                    echo "Could not find Failing step log by name, searching all logs..."
                    if find /tmp/workflow-logs -type f -exec grep -q "Error: buildx failed with: ERROR: failed to build: failed to solve: frontend grpc server closed unexpectedly" {} \; 2>/dev/null; then
                      echo "‚úÖ Detected flaky grpc server error in logs, will retry"
                      echo "should_retry=true" >> $GITHUB_OUTPUT
                      rm -rf /tmp/workflow-logs /tmp/workflow-logs.zip
                      exit 0
                    fi
                  elif check_error_pattern "$STEP_LOG"; then
                    echo "‚úÖ Detected flaky grpc server error, will retry"
                    echo "should_retry=true" >> $GITHUB_OUTPUT
                    rm -rf /tmp/workflow-logs /tmp/workflow-logs.zip
                    exit 0
                  fi
                  
                  echo "‚ùå Step failed with a different error, will not retry"
                  echo "should_retry=false" >> $GITHUB_OUTPUT
                  rm -rf /tmp/workflow-logs /tmp/workflow-logs.zip
                  exit 0
                fi
              fi
              
              if [ $i -lt 3 ]; then
                echo "Download attempt $i failed, retrying..."
                sleep 5
              fi
            done
          done
          
          # If we get here, we couldn't fetch logs
          echo "‚ö†Ô∏è Could not fetch logs after all attempts, will not retry (to be safe)"
          echo "should_retry=false" >> $GITHUB_OUTPUT

      - name: Sleep before retry
        if: steps.failing-step.outcome == 'failure' && steps.check-error.outputs.should_retry == 'true'
        run: |
          echo "Sleeping for 30s before retry..."
          sleep 30

      - name: Retry step
        if: steps.failing-step.outcome == 'failure' && steps.check-error.outputs.should_retry == 'true'
        id: retry-step
        run: |
          echo "This is the retry step"
          echo "Retry successful!"

      - name: Fail if step did not succeed
        if: steps.failing-step.outcome == 'failure' && (steps.check-error.outputs.should_retry != 'true' || steps['retry-step'].outcome != 'success')
        run: |
          echo "Step failed and retry was not attempted or retry also failed"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "TEST SUMMARY"
          echo "=========================================="
          echo "Failing step outcome: ${{ steps.failing-step.outcome }}"
          echo "Should retry: ${{ steps.check-error.outputs.should_retry }}"
          if [ "${{ steps.failing-step.outcome }}" == "failure" ]; then
            if [ "${{ steps.check-error.outputs.should_retry }}" == "true" ]; then
              if [ "${{ steps.retry-step.outcome }}" == "success" ]; then
                echo "‚úÖ RESULT: Flaky error detected ‚Üí Retry succeeded ‚Üí Job should pass"
              else
                echo "‚ùå RESULT: Flaky error detected ‚Üí Retry failed ‚Üí Job should fail"
              fi
            else
              echo "‚ùå RESULT: Different error (not flaky) ‚Üí No retry ‚Üí Job should fail"
            fi
          else
            echo "‚úÖ RESULT: First step succeeded ‚Üí No retry needed ‚Üí Job should pass"
          fi
          echo "=========================================="

